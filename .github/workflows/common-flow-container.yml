name: default (common) flow for container runs

on:
  workflow_call:
    inputs:
      env:
        default: "ubuntu-latest"
        type: string
      container:
        required: true
        type: string
      container_options:
        type: string
        default: --cpus 2
      san:
        type: string
      get-redis:
        type: boolean

env:
  SUDO: ""

jobs:
  common-flow:
    runs-on: ${{ inputs.env }}
    container:
      image: ${{ inputs.container }}
      options: ${{ inputs.container_options }}
# From this point on, the file should be identical to the other common flow.
    defaults:
      run:
        shell: bash -l -eo pipefail {0}
    steps:
      - name: Deps checkout
        uses: actions/checkout@v3
        with:
          submodules: true
      - run: |
          git config --global --add safe.directory '*'
          git submodule update --init --recursive
      - name: Setup
        run: |
          ./sbin/setup
      # TODO: use this instead
      # - name: Deps checkout
      # uses: actions/checkout@v3
      # with:
      #     sparse-checkout: .install
      # - name: Setup
      #   run: |
      #     ${{env.SUDO}} ./.install/install_script.sh
      - name: Full checkout
        uses: actions/checkout@v3
        with:
          submodules: recursive
          set-safe-directory: "'*'"
      - name: Get Redis
        if: ${{ inputs.get-redis }}
        run: |
          export GITHUB_TOKEN="${{ secrets.GITHUB_TOKEN }}"
          ./deps/readies/bin/getredis --with-github-token
      - name: Build
        run: |
          make SAN=${{ inputs.san }}
          make COORD=1 SAN=${{ inputs.san }}
      - name: Unit tests
        run: |
          make unit-tests SAN=${{ inputs.san }}
      - name: Flow tests
        run: |
          make pytest QUICK=1 SAN=${{ inputs.san }}
      - name: Unit tests (coordinator)
        run: |
          make COORD=1 unit-tests SAN=${{ inputs.san }}
      - name: Flow tests (coordinator)
        run: |
          make COORD=1 pytest QUICK=1 SAN=${{ inputs.san }}
