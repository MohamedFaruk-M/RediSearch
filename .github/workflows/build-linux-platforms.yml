name: Build on Linux Platforms

on:
  workflow_dispatch:
    inputs:
      platforms:
        type: choice
        options:
          - all
          - ubuntu:jammy
          - ubuntu:bionic
          - centos:7
          - rockylinux:8
          - debian:bullseye
        description: 'Build platforms'
        default: 'all'

jobs:
  get-required-envs:
    runs-on: ubuntu-latest
    outputs:
      platforms: ${{ steps.get_platforms.outputs.platforms }}
    steps:
      - name: Get platforms
        id: get_platforms
        run: |
          if [ "${{ github.event.inputs.platforms }}" = "all" ]; then
            # get all platforms from the options, except the first one
            echo "::set-output name=platforms::${{ toJson(fromJson(inputs.platforms.options)[1:]) }}"
          else
            # get the chosen platform
            echo "::set-output name=platforms::${{ toJson(inputs.platforms) }}"
          fi
  build-linux-matrix:
    needs: get-required-envs
    strategy:
      matrix:
        OS: ${{ fromJson(needs.get-required-envs.outputs.platforms) }}
      fail-fast: false
    uses: ./.github/workflows/common-flow-container.yml
    with:
      get-redis: true
      container: ${{ matrix.OS }}
    secrets: inherit
